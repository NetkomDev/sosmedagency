<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi Perangkat - MisiCuan</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { supabase } from './api.js';

        // =======================================
        // Advanced Device Fingerprint Generator
        // =======================================
        async function generateFingerprint() {
            const components = [];

            // 1. Basic browser info
            components.push(navigator.userAgent || '');
            components.push(navigator.language || '');
            components.push(navigator.hardwareConcurrency || 0);
            components.push(`${screen.width}x${screen.height}x${screen.colorDepth}`);
            components.push(navigator.platform || '');

            // 2. Timezone
            try {
                components.push(Intl.DateTimeFormat().resolvedOptions().timeZone || '');
                components.push(new Date().getTimezoneOffset());
            } catch (e) { components.push('tz-err'); }

            // 3. Canvas Fingerprint (very unique per device/browser)
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 240;
                canvas.height = 60;
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'alphabetic';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.font = '14px Arial';
                ctx.fillText('MisiCuan FP üéØ', 2, 15);
                ctx.fillStyle = 'rgba(102,204,0,0.7)';
                ctx.font = '18px Georgia';
                ctx.fillText('MisiCuan FP üéØ', 4, 45);
                // Add arc and gradient for more variation
                ctx.beginPath();
                ctx.arc(50, 50, 50, 0, Math.PI * 2, true);
                ctx.closePath();
                ctx.fill();
                const gradient = ctx.createLinearGradient(0, 0, 240, 0);
                gradient.addColorStop(0, 'red');
                gradient.addColorStop(1, 'blue');
                ctx.fillStyle = gradient;
                ctx.fillRect(100, 30, 80, 20);
                components.push(canvas.toDataURL());
            } catch (e) { components.push('canvas-err'); }

            // 4. WebGL Renderer (very unique per GPU)
            try {
                const glCanvas = document.createElement('canvas');
                const gl = glCanvas.getContext('webgl') || glCanvas.getContext('experimental-webgl');
                if (gl) {
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        components.push(gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) || '');
                        components.push(gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) || '');
                    }
                    components.push(gl.getParameter(gl.VERSION) || '');
                    components.push(gl.getParameter(gl.SHADING_LANGUAGE_VERSION) || '');
                    components.push(gl.getParameter(gl.MAX_TEXTURE_SIZE) || '');
                }
            } catch (e) { components.push('webgl-err'); }

            // 5. Audio context fingerprint
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const analyser = audioCtx.createAnalyser();
                const gain = audioCtx.createGain();
                const processor = audioCtx.createScriptProcessor(4096, 1, 1);
                gain.gain.value = 0; // mute
                oscillator.type = 'triangle';
                oscillator.connect(analyser);
                analyser.connect(processor);
                processor.connect(gain);
                gain.connect(audioCtx.destination);
                components.push(audioCtx.sampleRate || '');
                components.push(audioCtx.destination.maxChannelCount || '');
                oscillator.disconnect();
                audioCtx.close();
            } catch (e) { components.push('audio-err'); }

            // 6. Touch support
            components.push(navigator.maxTouchPoints || 0);
            components.push('ontouchstart' in window ? 1 : 0);

            // 7. Device memory (Chrome)
            components.push(navigator.deviceMemory || 'unknown');

            // 8. Installed media types (varies per device)
            try {
                const mediaTypes = ['video/mp4', 'video/webm', 'audio/ogg', 'audio/mp4', 'video/ogg'];
                const support = mediaTypes.map(t => {
                    try { return MediaSource.isTypeSupported(t) ? 1 : 0; } catch (e) { return -1; }
                });
                components.push(support.join(','));
            } catch (e) { components.push('media-err'); }

            // Hash all components together
            const raw = components.join('|||');
            const encoder = new TextEncoder();
            const data = encoder.encode(raw);

            // Use SHA-256 for a proper hash
            try {
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 48);
            } catch (e) {
                // Fallback: simple hash
                let hash = 0;
                for (let i = 0; i < raw.length; i++) {
                    const char = raw.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0;
                }
                return Math.abs(hash).toString(36) + '-' + btoa(raw.substring(0, 64)).substring(0, 24);
            }
        }

        async function init() {
            const status = document.getElementById('status');
            const icon = document.getElementById('icon-container');

            // Support both Telegram WebApp AND WhatsApp (URL parameter)
            let userId = null;
            let username = 'User';

            // Try Telegram WebApp first (backward compatibility)
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    const tgUser = tg.initDataUnsafe?.user;
                    if (tgUser) {
                        userId = tgUser.id;
                        username = tgUser.username || tgUser.first_name || 'User';
                    }
                }
            } catch (e) { /* Not in Telegram, skip */ }

            // Fallback: WhatsApp / URL parameter (?uid=6281234567890&name=John)
            if (!userId) {
                const params = new URLSearchParams(window.location.search);
                userId = params.get('uid');
                username = params.get('name') || 'Pasukan';
            }

            if (!userId) {
                status.innerHTML = "‚ùå Akses ditolak. Harap buka melalui Bot WhatsApp MisiCuan.";
                icon.innerHTML = 'üö´';
                return;
            }

            // Start Verifying Automatically
            async function doVerify() {
                try {
                    // Advanced Fingerprint computation (canvas + webGL + audio + more)
                    const fingerprint = await generateFingerprint();

                    // IP Fetch in background with timeout (don't wait more than 2s for IP)
                    const fetchIp = async () => {
                        try {
                            const res = await fetch('https://api.ipify.org?format=json', { signal: AbortSignal.timeout(2000) });
                            const json = await res.json();
                            return json.ip || '0.0.0.0';
                        } catch (e) { return '0.0.0.0'; }
                    };
                    const ip_address = await fetchIp();

                    // Check duplicate: same fingerprint AND same IP on a DIFFERENT account
                    const { data: duplicates, error: errDup } = await supabase
                        .from('profiles')
                        .select('id, username')
                        .eq('device_fingerprint', fingerprint)
                        .eq('ip_address', ip_address)
                        .neq('id', userId)
                        .limit(1);

                    if (duplicates && duplicates.length > 0) {
                        icon.innerHTML = 'üö®';
                        icon.classList.remove('border-emerald-500', 'shadow-[0_0_15px_rgba(16,185,129,0.5)]', 'animate-pulse');
                        icon.classList.add('border-rose-500', 'shadow-[0_0_15px_rgba(225,29,72,0.8)]');
                        status.className = "text-sm mb-6 text-rose-400 font-medium";
                        status.innerHTML = `<b>TERDETEKSI KECURANGAN!</b><br>Perangkat ini sudah digunakan oleh akun lain <i>(@${duplicates[0].username || duplicates[0].id})</i>.`;

                        await supabase.from('profiles').upsert({
                            id: userId,
                            username: username,
                            device_fingerprint: fingerprint,
                            ip_address: ip_address,
                            is_device_verified: false
                        }, { onConflict: 'id' });

                        return;
                    }

                    // Save verified data
                    const { error } = await supabase
                        .from('profiles')
                        .upsert({
                            id: userId,
                            username: username,
                            device_fingerprint: fingerprint,
                            ip_address: ip_address,
                            is_device_verified: true
                        }, { onConflict: 'id' });

                    if (error) throw error;

                    // Success! Show tick mark
                    icon.innerHTML = `<svg class="w-12 h-12 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    icon.classList.remove('animate-pulse');
                    status.innerHTML = `‚úÖ <b>Verifikasi Berhasil!</b><br>Sistem aman. Kembali ke WhatsApp dan ketik <b>1</b> untuk melihat Daftar Misi.
                        <br><br>
                        <a href="https://wa.me/6285694488510?text=1" 
                           style="display:inline-block; background: linear-gradient(135deg, #10b981, #059669); color:white; padding: 12px 28px; border-radius: 50px; text-decoration: none; font-weight: bold; font-size: 14px; box-shadow: 0 4px 15px rgba(16,185,129,0.4); transition: all 0.3s ease;"
                           onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(16,185,129,0.6)'"
                           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(16,185,129,0.4)'"
                        >üí¨ Kembali ke WhatsApp</a>`;

                } catch (err) {
                    icon.innerHTML = '‚ùå';
                    icon.classList.remove('animate-pulse');
                    status.innerHTML = "Gagal memvalidasi: " + err.message + "<br><button onclick='location.reload()' class='mt-4 underline text-emerald-400'>Coba Lagi</button>";
                }
            }

            // Start immediately
            doVerify();
        }

        init();
    </script>
    <!-- Telegram WebApp JS (optional, for backward compat) -->
    <script src="https://telegram.org/js/telegram-web-app.js" onerror=""></script>
</head>

<body class="bg-slate-900 text-white font-sans flex items-center justify-center min-h-screen p-5">
    <div
        class="bg-gray-800 p-8 rounded-3xl shadow-xl w-full max-w-sm text-center border border-gray-700 relative overflow-hidden">

        <!-- Glowing animated background -->
        <div
            class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-emerald-400 via-teal-500 to-emerald-400 opacity-50">
        </div>

        <div class="mb-8 mt-4 flex justify-center">
            <span id="icon-container"
                class="flex items-center justify-center w-24 h-24 text-4xl border-4 border-emerald-500 rounded-full relative shadow-[0_0_15px_rgba(16,185,129,0.5)] animate-pulse transition-all duration-300">
                <!-- SVG Spinner -->
                <svg class="animate-spin h-10 w-10 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </span>
        </div>

        <h1 class="text-xl font-bold mb-2 tracking-wide text-gray-100">Memeriksa Keamanan Perangkat</h1>
        <p class="text-sm text-gray-400 mb-6 leading-relaxed">Sistem mendeteksi dan mengamankan sidik jari digital Anda
            untuk mencegah pembuatan multi-akun...</p>

        <p id="status" class="text-sm text-emerald-400 font-medium"></p>
    </div>
</body>

</html>